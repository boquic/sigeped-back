// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ─────────────────── ENUMS ───────────────────
enum EstadoPedido {
  pendiente_revision
  validado
  rechazado
  en_produccion
  completado
  entregado
}

enum EstadoPago {
  pendiente_envio
  enviado
  validado
  rechazado
}

enum OrigenPedido {
  whatsapp
  web
  interno
}

// ─────────────────── ROLES Y USUARIOS ───────────────────
model Rol {
  id          Int      @id @default(autoincrement())
  nombreRol   String   @unique
  descripcion String?
  permisos    Json?
  createdAt   DateTime @default(now())

  usuarios Usuario[]
}

model Usuario {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String
  email        String    @unique
  telefono     String?
  rolId        Int
  activo       Boolean   @default(true)
  ultimoAcceso DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  rol                 Rol                  @relation(fields: [rolId], references: [id])
  pedidosAsignados    Pedido[]             @relation("OperarioAsignado")
  historialEstados    HistorialEstado[]
  validaciones        Validacion[]
  pagosValidados      Pago[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
}

model RefreshToken {
  id            Int       @id @default(autoincrement())
  userId        Int
  token_hash    String    @unique
  is_revoked    Boolean   @default(false)
  expires_at    DateTime
  created_at    DateTime  @default(now())
  replaced_by_id Int?
  user_agent    String?
  ip            String?

  user       Usuario       @relation(fields: [userId], references: [id], onDelete: Cascade)
  replacedBy RefreshToken? @relation("TokenReplacement", fields: [replaced_by_id], references: [id])
  replaced   RefreshToken[] @relation("TokenReplacement")

  @@index([userId])
  @@index([expires_at])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id         Int       @id @default(autoincrement())
  userId     Int
  token_hash String    @unique
  expires_at DateTime
  used_at    DateTime?

  user Usuario @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires_at])
  @@map("password_reset_tokens")
}

// ─────────────────── CLIENTES Y SESIONES CHATBOT ───────────────────
model Cliente {
  id              Int       @id @default(autoincrement())
  nombreCompleto  String
  telefono        String    @unique
  whatsappChatId  String?   @unique
  email           String?
  direccion       String?
  activo          Boolean   @default(true)
  fechaRegistro   DateTime  @default(now())
  ultimoContacto  DateTime?
  metadata        Json?

  pedidos         Pedido[]
  sesionesChatbot SesionChatbot[]
  notificaciones  Notificacion[]
}

model SesionChatbot {
  id                  Int       @id @default(autoincrement())
  clienteId           Int
  estadoConversacion  String
  contexto            Json?
  fechaInicio         DateTime  @default(now())
  fechaUltimoMensaje  DateTime?
  sesionActiva        Boolean   @default(true)
  ultimoMensaje       String?

  cliente Cliente @relation(fields: [clienteId], references: [id])
}

// ─────────────────── SERVICIOS, MATERIALES Y PLANTILLAS ───────────────────
model Servicio {
  id                    Int       @id @default(autoincrement())
  nombreServicio        String    @unique
  descripcion           String?
  precioBase            Decimal   @db.Decimal(10,2)
  tiempoEstimadoMinutos Int?
  requierePlantilla     Boolean   @default(false)
  activo                Boolean   @default(true)
  configuracion         Json?
  createdAt             DateTime  @default(now())

  plantillas            Plantilla[]
  pedidos               Pedido[]
  metricasPrecalculadas MetricaPrecalculada[]
}

model Material {
  id              Int      @id @default(autoincrement())
  nombreMaterial  String   @unique
  tipo            String
  precioPorUnidad Decimal  @db.Decimal(10,2)
  stockActual     Int?
  stockMinimo     Int?
  unidadMedida    String?
  activo          Boolean  @default(true)
  updatedAt       DateTime @updatedAt

  pedidos Pedido[]
}

model Plantilla {
  id              Int      @id @default(autoincrement())
  servicioId      Int
  nombrePlantilla String
  rutaArchivo     String
  tipoArchivo     String
  tamanoMb        Decimal  @db.Decimal(6,2)
  instrucciones   String?
  version         Int      @default(1)
  activa          Boolean  @default(true)
  createdAt       DateTime @default(now())

  servicio Servicio @relation(fields: [servicioId], references: [id])
}

// ─────────────────── PEDIDOS Y RELACIONADOS ───────────────────
model Pedido {
  id                     Int          @id @default(autoincrement())
  codigoPedido           String       @unique
  clienteId              Int
  servicioId             Int
  materialId             Int
  operarioAsignadoId     Int?
  cantidad               Decimal      @db.Decimal(10,2)
  estado                 EstadoPedido @default(pendiente_revision)
  descripcionCliente     String?
  precioTotal            Decimal?     @db.Decimal(10,2)
  tiempoEstimadoMinutos  Int?
  origen                 OrigenPedido @default(whatsapp)
  fechaCreacion          DateTime     @default(now())
  fechaValidacion        DateTime?
  fechaInicioProduccion  DateTime?
  fechaCompletado        DateTime?
  fechaEntrega           DateTime?
  updatedAt              DateTime     @updatedAt

  cliente  Cliente   @relation(fields: [clienteId], references: [id])
  servicio Servicio  @relation(fields: [servicioId], references: [id])
  material Material  @relation(fields: [materialId], references: [id])
  operario Usuario?  @relation("OperarioAsignado", fields: [operarioAsignadoId], references: [id])

  archivos         ArchivoAdjunto[]
  historialEstados HistorialEstado[]
  validaciones     Validacion[]
  pagos            Pago[]
  notificaciones   Notificacion[]
}

model ArchivoAdjunto {
  id              Int      @id @default(autoincrement())
  pedidoId        Int
  nombreOriginal  String
  rutaArchivo     String
  tipoArchivo     String
  tamanoMb        Decimal  @db.Decimal(6,2)
  hashArchivo     String?
  version         Int      @default(1)
  esVersionActual Boolean  @default(true)
  fechaSubida     DateTime @default(now())

  pedido Pedido @relation(fields: [pedidoId], references: [id])
}

model HistorialEstado {
  id             Int           @id @default(autoincrement())
  pedidoId       Int
  estadoAnterior EstadoPedido?
  estadoNuevo    EstadoPedido
  usuarioId      Int?
  observaciones  String?
  fechaCambio    DateTime      @default(now())

  pedido  Pedido   @relation(fields: [pedidoId], references: [id])
  usuario Usuario? @relation(fields: [usuarioId], references: [id])
}

model Validacion {
  id               Int      @id @default(autoincrement())
  pedidoId         Int
  operarioId       Int
  resultado        String
  motivo           String?
  detallesTecnicos Json?
  fechaValidacion  DateTime @default(now())

  pedido   Pedido  @relation(fields: [pedidoId], references: [id])
  operario Usuario @relation(fields: [operarioId], references: [id])
}

// ─────────────────── PAGOS Y MÉTODOS ───────────────────
model MetodoPago {
  id           Int     @id @default(autoincrement())
  nombreMetodo String
  instrucciones String?
  numeroCuenta String?
  codigoQrUrl  String?
  activo       Boolean @default(true)

  pagos Pago[]
}

model Pago {
  id                Int         @id @default(autoincrement())
  pedidoId          Int
  metodoPagoId      Int
  montoTotal        Decimal     @db.Decimal(10,2)
  estadoPago        EstadoPago  @default(pendiente_envio)
  rutaComprobante   String?
  origenCaptura     String?
  validadorId       Int?
  observaciones     String?
  fechaPagoCliente  DateTime?
  fechaValidacion   DateTime?
  createdAt         DateTime    @default(now())

  pedido     Pedido     @relation(fields: [pedidoId], references: [id])
  metodoPago MetodoPago @relation(fields: [metodoPagoId], references: [id])
  validador  Usuario?   @relation(fields: [validadorId], references: [id])
}

// ─────────────────── NOTIFICACIONES Y MÉTRICAS ───────────────────
model Notificacion {
  id                Int       @id @default(autoincrement())
  clienteId         Int
  pedidoId          Int
  tipo              String
  mensaje           String
  estadoEnvio       String
  whatsappMessageId String?
  intentosEnvio     Int       @default(0)
  fechaProgramada   DateTime?
  fechaEnviada      DateTime?
  fechaLeida        DateTime?
  metadata          Json?

  cliente Cliente @relation(fields: [clienteId], references: [id])
  pedido  Pedido  @relation(fields: [pedidoId], references: [id])
}

model MetricaPrecalculada {
  id                     Int      @id @default(autoincrement())
  servicioId             Int
  fecha                  DateTime
  totalPedidos           Int
  pedidosCompletados     Int
  pedidosRechazados      Int
  ingresosTotales        Decimal  @db.Decimal(12,2)
  tiempoPromedioMinutos  Int
  tasaRechazoPorcentaje  Decimal  @db.Decimal(5,2)
  ultimaActualizacion    DateTime @default(now())

  servicio Servicio @relation(fields: [servicioId], references: [id])
}